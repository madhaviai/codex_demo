name: Codex Auto-Fix for Billing Service

on:
  workflow_run:
    workflows: ["billing-service-ci"]
    types: [completed]

jobs:
  autofix:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}

    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - run: pip install -r requirements.txt

      - uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt: |
            Fix minimal issues so all tests in this repo pass.
            Do not refactor or add files.
          codex-args: '["--config","sandbox_mode=\"workspace-write\""]'

      - run: pytest

      - if: success()
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "fix: auto-correct billing service using Codex"
          branch: codex/auto-fix
          title: "Codex auto-fix PR"
